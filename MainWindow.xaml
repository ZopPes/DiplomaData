<Window
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:DiplomaData"
    xmlns:CommandColection="clr-namespace:DiplomaData.Tabs.CommandColection"
    xmlns:model="clr-namespace:DiplomaData.Model"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    x:Name="window"
    x:Class="DiplomaData.MainWindow"
    mc:Ignorable="d"
        Title="Хранилище дипломных работ"
    FontSize="18">
    <Window.Resources>
        <CollectionViewSource x:Key="tabs" Source="{Binding Tabs}" />
    </Window.Resources>
    <Window.DataContext>
        <local:MainVM />
    </Window.DataContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="auto" />
            <RowDefinition />
            <RowDefinition Height="auto" />
        </Grid.RowDefinitions>
        <Menu>
            <MenuItem Header="данные" Command="{Binding UpdateData, IsAsync=True}" />
        </Menu>
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width=".4*" />
                <ColumnDefinition />
                <ColumnDefinition Width=".4*" />
            </Grid.ColumnDefinitions>
            <TreeView>

                <TreeViewItem IsExpanded="True" ItemsSource="{Binding TableCommand}" Header="Таблицы">
                    <TreeViewItem.ItemTemplate>
                        <DataTemplate DataType="{x:Type CommandColection:AddCommand}">
                            <Button Content="{Binding Name}" Command="{Binding}" />
                        </DataTemplate>
                    </TreeViewItem.ItemTemplate>
                </TreeViewItem>
                <TreeViewItem Header="Отчёты" ItemsSource="{Binding ReportCommands}">
                    <TreeViewItem.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Обновить" Command="{Binding UpdateReports}" />
                        </ContextMenu>
                    </TreeViewItem.ContextMenu>
                    <TreeViewItem.ItemTemplate>
                        <DataTemplate DataType="{x:Type CommandColection:AddCommand}">
                            <Button Content="{Binding Name}" Command="{Binding}" />
                        </DataTemplate>
                    </TreeViewItem.ItemTemplate>
                </TreeViewItem>
            </TreeView>
            <TabControl x:Name="tabControl" Grid.Column="1" SelectedIndex="0" SelectedValue="{Binding Tabs.SelectedItem}">

                <TabControl.ItemsSource>
                    <CompositeCollection>
                        <CollectionContainer  Collection="{Binding Source={StaticResource tabs}}" />
                    </CompositeCollection>
                </TabControl.ItemsSource>
                <TabControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type local:Tab}">
                        <TextBlock>
                        <Run Text="{Binding Name, Mode=OneWay}" />
                        <Hyperlink Command="{Binding Close}">X</Hyperlink>
                        </TextBlock>
                    </DataTemplate>
                </TabControl.ItemTemplate>
                <TabControl.ContentTemplate>
                    <DataTemplate DataType="{x:Type local:Tab}">
                        <Grid x:Name="list">
                            <Grid.Resources>
                                <Style TargetType="ComboBox">
                                    <Setter Property="ItemTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding}"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Grid.Resources>
                            <Grid.RowDefinitions>
                                <RowDefinition/>
                                <RowDefinition Height="auto"/>
                            </Grid.RowDefinitions>
                            <ScrollViewer VerticalScrollBarVisibility="Visible" CanContentScroll="True">
                                <ItemsControl Margin="5" ItemsSource="{Binding SelectData}">
                                <ItemsControl.Resources>
                                    <DataTemplate   DataType="{x:Type model:Student}">
                                            <Border Margin="5" Padding="10" BorderBrush="Black" BorderThickness="1">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition />
                                                    <ColumnDefinition Width="AUTO"/>
                                                        <ColumnDefinition Width=".5*"/>
                                                </Grid.ColumnDefinitions>
                                            <TextBox PreviewTextInput="TextBox_PreviewTextInput">
                                                <TextBox.Text>
                                                    <MultiBinding Converter="{StaticResource Fio}">
                                                        <Binding Path="surname"/>
                                                        <Binding Path="name"/>
                                                        <Binding Path="patronymic"/>
                                                    </MultiBinding>
                                                </TextBox.Text>
                                            </TextBox>
                                            <ComboBox Grid.Column="1" SelectedItem="{Binding Group}" 
                                                      ItemsSource="{Binding DataContext.DiplomaData.Group, ElementName=window}"
                                                      >
                                            </ComboBox>
                                            <Button Grid.Column="2" Background="Transparent" BorderBrush="Transparent"
                                                    Content="Ⅹ" Command="{Binding DataContext.RemoveTable, ElementName=list}"
                                                    CommandParameter="{Binding}"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"/>
                                            
                                        </Grid>
                                            </Border>
                                    </DataTemplate>

                                    <DataTemplate   DataType="{x:Type model:Group}">
                                            <Border Padding="10" BorderBrush="Black" BorderThickness="1" Margin="10">
                                        <Grid >
                                            
                                            <Grid.ColumnDefinitions>
                                                    <ColumnDefinition  Width="auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition/>
                                            </Grid.ColumnDefinitions>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition/>
                                                    <RowDefinition/>
                                                    <RowDefinition/>
                                                    <RowDefinition/>
                                                </Grid.RowDefinitions>
                                                <Label Content="Номер:" />
                                                <Label Content="Куратор:" Grid.Row="1"/>
                                                <Label Content="форма обучения:" Grid.Row="2"/>
                                                <Label Content="Специальность:" Grid.Row="3"/>
                                            
                                                <TextBox MaxLength="4" Grid.Column="1" Text="{Binding number}"/>
                                                <ComboBox Grid.Column="1" Grid.Row="1" SelectedItem="{Binding Lecturer}" ItemsSource="{Binding DataContext.DiplomaData.Lecturer, ElementName=window}" />
                                                <ComboBox Grid.Column="1" Grid.Row="2" SelectedItem="{Binding Form_of_education1}" ItemsSource="{Binding DataContext.DiplomaData.Form_of_education, ElementName=window}" />
                                                <ComboBox Grid.Column="1" Grid.Row="3" SelectedItem="{Binding Specialty1}" ItemsSource="{Binding DataContext.DiplomaData.Specialty, ElementName=window}" />
                                            
                                            <Button HorizontalAlignment="Right" Grid.Column="3" VerticalAlignment="Top" Background="Transparent" BorderBrush="Transparent" Content="Ⅹ" Command="{Binding DataContext.RemoveTable, ElementName=list}"
                                                    CommandParameter="{Binding}"/>
                                        </Grid>
                                            </Border>
                                    </DataTemplate>

                                    <DataTemplate   DataType="{x:Type model:Specialty}">
                                            <Border BorderBrush="Black" BorderThickness="1" Margin="10" Padding="5">
                                                <Grid>
                                            <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="auto"/>
                                                    <ColumnDefinition Width="3*"/>
                                                    <ColumnDefinition/>
                                            </Grid.ColumnDefinitions>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition/>
                                                    <RowDefinition/>
                                                </Grid.RowDefinitions>
                                                <Label Content="номер:"/>
                                                <Label VerticalAlignment="Center" Content="Название:" Grid.Row="1"/>
                                                <TextBox Grid.Column="1" MaxLength="6" Text="{Binding cipher}"/>
                                                <TextBox TextWrapping="Wrap" Grid.Row="1" Grid.Column="1" Text="{Binding name}"/>
                                            
                                            <Button Grid.Column="2" HorizontalAlignment="Right" VerticalAlignment="Top" Background="Transparent" BorderBrush="Transparent" Content="Ⅹ" Command="{Binding DataContext.RemoveTable, ElementName=list}"
                                                    CommandParameter="{Binding}"/>
                                        </Grid>
                                            </Border>
                                    </DataTemplate>

                                    <DataTemplate   DataType="{x:Type model:Thesis}">
                                            <Border BorderBrush="Black" BorderThickness="1" Padding="5" Margin="10">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="auto"/>
                                                        <ColumnDefinition Width="3*"/>
                                                        <ColumnDefinition/>
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="auto"/>
                                                        <RowDefinition/>
                                                        <RowDefinition/>
                                                    </Grid.RowDefinitions>
                                                    <Label >
                                                        <Label.Resources>
                                                            <Style TargetType="Label">
                                                                <Style.Triggers>
                                                                <DataTrigger Binding="{Binding used}" Value="true">
                                                                        <Setter Property="Content" Value="уже используется"/>
                                                                    </DataTrigger>
                                                                    
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Label.Resources>
                                                    </Label>
                                                    <Label Grid.Row="1" Content="название:" VerticalAlignment="Center"/>
                                                    <Label Content="описание:" Grid.Row="2" VerticalAlignment="Center"/>
                                                    <TextBox Grid.Column="1" Grid.Row="1" TextWrapping="Wrap" Text="{Binding name}"/>
                                                <TextBox Grid.Column="1" Grid.Row="2" TextWrapping="Wrap" Text="{Binding description}"/>
                                            <TextBlock Grid.Column="2" Grid.Row="2" VerticalAlignment="Bottom" HorizontalAlignment="Right" Text="{Binding date, StringFormat={}{0:dd.MM.yyyy}}"/>
                                                    <Button Grid.Column="2" Grid.RowSpan="2" HorizontalAlignment="Right" VerticalAlignment="Top" Background="Transparent" BorderBrush="Transparent" Content="Ⅹ" Command="{Binding DataContext.RemoveTable, ElementName=list}"
                                                    CommandParameter="{Binding}"/>
                                                </Grid>
                                            </Border>
                                    </DataTemplate>
                                    <DataTemplate  DataType="{x:Type model:Lecturer}">
                                            <Border Margin="5" Padding="10" BorderBrush="Black" BorderThickness="1">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition />
                                                        <ColumnDefinition Width=".2*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBox PreviewTextInput="TextBox_PreviewTextInput">
                                                        <TextBox.Text>
                                                            <MultiBinding Converter="{StaticResource Fio}">
                                                                <Binding Path="surname"/>
                                                                <Binding Path="name"/>
                                                                <Binding Path="patronymic"/>
                                                            </MultiBinding>
                                                        </TextBox.Text>
                                                    </TextBox>
                                                    <Button Grid.Column="1" Background="Transparent" BorderBrush="Transparent"
                                                    Content="Ⅹ" Command="{Binding DataContext.RemoveTable, ElementName=list}"
                                                    CommandParameter="{Binding}"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"/>

                                                </Grid>
                                            </Border>
                                        </DataTemplate>

                                </ItemsControl.Resources>
                            </ItemsControl>
                            </ScrollViewer>
                            <ContentControl Content="{Binding InsertItem}" Grid.Row="1">
                                <ContentControl.Resources>
                                    <DataTemplate DataType="{x:Type model:Student}">
                                        <Expander Header="Добавить" Grid.Row="1" >
                                            <StackPanel>
                                                <TextBox PreviewTextInput="TextBox_PreviewTextInput">
                                                    <TextBox.Text>
                                                        <MultiBinding Converter="{StaticResource Fio}">
                                                            <Binding Path="surname"/>
                                                            <Binding Path="name"/>
                                                            <Binding Path="patronymic"/>
                                                        </MultiBinding>
                                                    </TextBox.Text>
                                                </TextBox>
                                                <ComboBox SelectedItem="{Binding Group}"
                                                      ItemsSource="{Binding DataContext.DiplomaData.Group, ElementName=window}" />
                                                <Button Content="Добавить" 
                                                    Command="{Binding DataContext.InsertTable, ElementName=list}"/>
                                            </StackPanel>
                                        </Expander>
                                    </DataTemplate>
                                   
                                    <DataTemplate DataType="{x:Type model:Group}">
                                        <Expander Header="Добавить" Grid.Row="1" >
                                            <StackPanel>
                                                <TextBox Text="{Binding number}"/>
                                                <ComboBox 
                                                    SelectedItem="{Binding Lecturer}" 
                                                    ItemsSource="{Binding DataContext.DiplomaData.Lecturer, ElementName=window}" />
                                                <ComboBox SelectedItem="{Binding Form_of_education1}" ItemsSource="{Binding DataContext.DiplomaData.Form_of_education, ElementName=window}"/>
                                                <ComboBox SelectedItem="{Binding Specialty1}" ItemsSource="{Binding DataContext.DiplomaData.Specialty, ElementName=window}" />
                                                <Button Content="Добавить" 
                                                    Command="{Binding DataContext.InsertTable, ElementName=list}"/>
                                            </StackPanel>
                                        </Expander>
                                    </DataTemplate>

                                    <DataTemplate DataType="{x:Type model:Lecturer}">
                                        <Expander Header="Добавить" Grid.Row="1" >
                                            <StackPanel>
                                                <TextBox PreviewTextInput="TextBox_PreviewTextInput">
                                                    <TextBox.Text>
                                                        <MultiBinding Converter="{StaticResource Fio}">
                                                            <Binding Path="surname"/>
                                                            <Binding Path="name"/>
                                                            <Binding Path="patronymic"/>
                                                        </MultiBinding>
                                                    </TextBox.Text>
                                                </TextBox>
                                                <Button Content="Добавить" 
                                                    Command="{Binding DataContext.InsertTable, ElementName=list}"/>
                                            </StackPanel>
                                        </Expander>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type model:Thesis}">
                                        <Expander Header="Добавить" Grid.Row="1" >
                                            <StackPanel>
                                                <TextBox Text="{Binding name}"/>
                                                <TextBox Text="{Binding description}"/>
                                                <DatePicker IsDropDownOpen="True"
                                                            DisplayDateStart="1/1/1999" 
                                                            DisplayDateEnd="{x:Static sys:DateTime.Now}"
                                                            SelectedDate="{Binding date}"
                                                            IsTodayHighlighted="True"
                                                            SelectedDateFormat="Long"
                                                            KeyUp="DatePicker_KeyUp"/>
                                                <CheckBox IsChecked="{Binding used}" IsEnabled="False"/>
                                                <Button Content="Добавить" 
                                                    Command="{Binding DataContext.InsertTable, ElementName=list}"/>
                                            </StackPanel>
                                        </Expander>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type model:Specialty}">
                                        <Expander Header="Добавить" Grid.Row="1" >
                                            <StackPanel>
                                                <TextBox Text="{Binding cipher}"/>
                                                <TextBox Text="{Binding name}"/>
                                                <Button Content="Добавить" 
                                                    Command="{Binding DataContext.InsertTable, ElementName=list}"/>
                                            </StackPanel>
                                        </Expander>
                                    </DataTemplate>

                                </ContentControl.Resources>
                            </ContentControl>
                        </Grid>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>

            <StackPanel  Grid.Column="2">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition Width="auto" />
                    </Grid.ColumnDefinitions>
                    <TextBox x:Name="textBox" Text="{Binding Tabs.SelectedItem.Filter}"/>
                    <Rectangle Grid.Column="1" Width="20" Height="20" Fill="#FFB9B9B9" />
                </Grid>

                <TextBlock Text="{Binding Tabs.SelectedItem.Specialties.Name}" />
                <ListBox x:Name="listBox" ItemsSource="{Binding Tabs.SelectedItem.Specialties}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding Specialty1}" />
                                <Button Content="X" Grid.Column="1"
                                        Command="{Binding ItemsSource.RemoveCommand, ElementName=listBox}" CommandParameter="{Binding}" />
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="auto" />
                    </Grid.ColumnDefinitions>
                    <ComboBox x:Name="comboBox" ItemsSource="{Binding DiplomaData.Specialty}" />
                    <Button Grid.Column="1" Content="+"
                            Command="{Binding ItemsSource.AddCommand, ElementName=listBox}"
                            CommandParameter="{Binding SelectedItem, ElementName=comboBox}" />
                </Grid>
            </StackPanel>
        </Grid>
        <StatusBar Grid.Row="2" ItemsSource="{Binding Tabs.SelectedItem.Properties}">
            <StatusBar.ItemContainerStyle>
                <Style TargetType="StatusBarItem" BasedOn="{StaticResource {x:Type StatusBarItem}}">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="StatusBarItem">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="5" />
                                    </Grid.ColumnDefinitions>
                                    <ContentPresenter>
                                        <ContentPresenter.Content>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock FontSize="18" Margin="10,0">
                                                    <Run Text="{Binding Name, StringFormat={}{0}:,Mode=OneWay}" />
                                                    <Run Text="{Binding Value, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" />
                                                </TextBlock>
                                            </StackPanel>
                                        </ContentPresenter.Content>
                                    </ContentPresenter>
                                    <Separator Grid.Column="1"  Style="{StaticResource {x:Static StatusBar.SeparatorStyleKey}}" />
                                </Grid>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </StatusBar.ItemContainerStyle>
        </StatusBar>
    </Grid>
</Window>